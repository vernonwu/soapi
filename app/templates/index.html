<!doctype html><meta name=viewport content="width=device-width,initial-scale=1">
<title>House Laundry Queue</title>
<style>
  :root{
    --fg:#1f2937; --muted:#6b7280; --primary:#2563eb; --primary-600:#1d4ed8;
    --green:#16a34a; --red:#dc2626; --border:#e5e7eb; --bg:#f8fafc;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Arial;margin:0;background:var(--bg);color:var(--fg)}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:12px}
  h1{font-size:22px;margin:0}
  .actions{display:flex;gap:10px;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;text-decoration:none;border:1px solid var(--primary);
       color:#fff;background:var(--primary);transition:.2s}
  .btn:hover{background:var(--primary-600);border-color:var(--primary-600)}
  .ghost{background:transparent;color:var(--primary)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{position:relative;background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;min-width:360px;flex:1;
        box-shadow:0 6px 20px rgba(0,0,0,.06)}
  h2{margin:0 0 8px 0;font-size:18px}
  .cap{font-size:12px;color:var(--muted);margin-bottom:6px}
  form{display:inline-flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  input,button{padding:10px 12px;font-size:14px;border:1px solid var(--border);border-radius:10px}
  input:focus{outline:none;border-color:var(--primary)}
  button{background:#fff;cursor:pointer}
  button:hover{border-color:var(--primary)}
  ol{padding-left:20px;margin:10px 0}
  li{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:8px 0;border-bottom:1px dashed var(--border)}
  li:last-child{border-bottom:none}
  .left{display:flex;flex-direction:column;gap:4px}
  .badge{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 10px;background:#f3f4f6}
  .badge[data-state="running"]{background:#e0f2fe;border-color:#bae6fd}
  .badge[data-state="awaiting"]{background:#ecfdf5;border-color:#bbf7d0}
  .badge[data-state="overdue"]{background:#fef2f2;border-color:#fecaca}
  .controls{display:flex;gap:8px;align-items:center}
  .mono{font-variant-numeric: tabular-nums}
  .muted{color:var(--muted)}
  .danger{color:var(--red)}

  /* Delete button (center the red cross) */
  .delete-form{position:absolute;top:10px;right:12px}
  .delbtn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:28px;
    height:28px;
    padding:0;
    border:1px solid #ef4444;
    color:#b91c1c;
    border-radius:50%;
    font-size:16px;
    line-height:1;
    cursor:pointer;
  }
  .delbtn:hover{background:#fecaca}
</style>

<div class="container">
  <header>
    <h1>House Laundry Queue</h1>
    <div class="actions">
      <a class="btn" href="{{ url_for('laundry.new_machine') }}">Add machine</a>
      <a class="btn ghost" href="{{ url_for('laundry.logs_page') }}">View logs (7 days)</a>
    </div>
  </header>

  <div class="row">
  {% for m in machines %}
    <div class="card">
      <!-- delete button-->
      <form class="delete-form" method="POST" action="{{ url_for('laundry.delete_machine', machine_id=m['id']) }}"
            onsubmit="return confirm('Delete machine & all its tasks?');">
        <button class="delbtn" title="Delete machine">âœ–</button>
      </form>

      <h2>{{ m['name'] }}</h2>
      <div class="cap">Capacity: {{ m['max_concurrent'] }} â€¢ Running: {{ running_counts[m['id']] }} â€¢ Waiting: {{ waiting_counts[m['id']] }}</div>

      <form method="POST" action="{{ url_for('laundry.enqueue', machine_id=m['id']) }}">
        <input name="user" placeholder="Your name" required>
        <button>Add to queue</button>
      </form>

      <ol>
        {% set startable_ids = startable_map[m['id']] %}
        {% for r in queues[m['id']] %}
          <li data-res-id="{{ r['id'] }}">
            <div class="left">
              <div>
                <strong>{{ r['user'] }}</strong>
                {% if r['started'] %}
                  <span class="badge state-badge" data-state="running">running</span>
                  {% if r['has_remarks'] %}
                    <button type="button" title="Remarks" onclick="alert(this.dataset.text)" data-text="{{ r['remarks']|e }}">ðŸ’¬</button>
                  {% endif %}
                {% else %}
                  {% if r['id'] in startable_ids %}
                    <span class="badge">front of queue</span>
                  {% else %}
                    <span class="badge">queueingâ€¦</span>
                  {% endif %}
                  {% if r['has_remarks'] %}
                    <button type="button" title="Remarks" onclick="alert(this.dataset.text)" data-text="{{ r['remarks']|e }}">ðŸ’¬</button>
                  {% endif %}
                {% endif %}
              </div>

              {% if r['started'] %}
                <div class="mono">
                  Time remaining:
                  <span class="runline"
                        data-end="{{ r['end'].isoformat() }}"
                        data-grace="{{ r['grace_end'].isoformat() }}"></span>
                </div>
              {% endif %}
            </div>

            <div class="controls">
              {% if (not r['started']) and (r['id'] in startable_ids) %}
                <span class="mono muted">Idle: <span class="idle" data-frontsince="{{ r['front_since'] }}"></span></span>
                <form method="GET" action="{{ url_for('laundry.start_form', res_id=r['id']) }}">
                  <button>Start</button>
                </form>
              {% endif %}
              {% if (not r['started']) %}
                <form method="POST" action="{{ url_for('laundry.cancel_res', res_id=r['id']) }}">
                  <button type="submit">Cancel</button>
                </form>
              {% endif %}
              {% if r['started'] and not r['finished'] %}
                <form method="POST" action="{{ url_for('laundry.finish_res', res_id=r['id']) }}">
                  <button>Done</button>
                </form>
              {% endif %}
            </div>
          </li>
        {% else %}
          <li class="muted">No one queued.</li>
        {% endfor %}
      </ol>
    </div>
  {% endfor %}
  </div>
</div>

<script src="{{ url_for('static', filename='app.js') }}"></script>
